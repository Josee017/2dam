<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fitness+</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- BASE STYLES & RESET --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #000000; 
            color: white;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            padding-bottom: env(safe-area-inset-bottom);
            user-select: none;
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Icon Settings */
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24; }
        .icon-outlined { font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(164, 255, 0, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(164, 255, 0, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(164, 255, 0, 0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes slideDownToast { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.35s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-pop { animation: pop 0.3s ease-out; }
        .animate-toast { animation: slideDownToast 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        /* --- UTILITIES --- */
        .glass-nav { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 0.5px solid rgba(255, 255, 255, 0.12); }
        .glass-header { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(255, 255, 255, 0.1); }
        
        /* Form Elements */
        .toggle-checkbox:checked { right: 0; border-color: #30D158; }
        .toggle-checkbox:checked + .toggle-label { background-color: #30D158; }
        input:focus { outline: none; border-color: #A4FF00; }
        
        /* Gradients & Visuals */
        .bg-gradient-rings { background: radial-gradient(circle at 50% 50%, rgba(255,0,92,0.1), rgba(0,0,0,0)); }
        .award-gold { background: radial-gradient(circle at 30% 30%, #FFD700, #B8860B); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .award-silver { background: radial-gradient(circle at 30% 30%, #E0E0E0, #757575); }
        .award-bronze { background: radial-gradient(circle at 30% 30%, #CD7F32, #8B4513); }
        .award-special { background: radial-gradient(circle at 30% 30%, #A4FF00, #00F5EA); box-shadow: 0 0 15px rgba(164, 255, 0, 0.3); }
        
        /* Lock Overlay for Awards */
        .award-locked { filter: grayscale(1) brightness(0.5); opacity: 0.6; }

        /* Auth Buttons */
        .btn-social { position: relative; display: flex; align-items: center; justify-content: center; width: 100%; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 17px; transition: all 0.2s; }
        .btn-social:active { transform: scale(0.98); opacity: 0.9; }
        .btn-apple { background: white; color: black; }
        .btn-google { background: white; color: black; border: 1px solid #e5e7eb; }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#A4FF00', 
                        move: '#FA114F', exercise: '#A4FF00', stand: '#00F5EA',
                        ios: { bg: '#000000', card: '#1C1C1E', gray: '#8E8E93', blue: '#0A84FF', red: '#FF453A' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'] }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MOCK DATABASE ---
        const EXERCISE_DB = [
            { id: 'f1', title: 'Fuerza Total', trainer: 'Sarah', duration: 30, kcal: 210, type: 'Fuerza', level: 'Intermedio', img: 'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=800&q=80', isNew: true },
            { id: 'y1', title: 'Yoga para empezar', trainer: 'Jessica', duration: 20, kcal: 85, type: 'Yoga', level: 'Principiante', img: 'https://images.unsplash.com/photo-1544367563-12123d8965cd?w=800&q=80', isNew: true },
            { id: 'c1', title: 'Cardio Intenso', trainer: 'Mike', duration: 45, kcal: 450, type: 'HIIT', level: 'Avanzado', img: 'https://images.unsplash.com/photo-1538805060512-e28281313317?w=800&q=80', isNew: false },
            { id: 'm1', title: 'Meditación Zen', trainer: 'Tyrell', duration: 10, kcal: 15, type: 'Meditación', level: 'Principiante', img: 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=800&q=80', isNew: false },
            { id: 'b1', title: 'Baile Latino', trainer: 'Javier', duration: 30, kcal: 200, type: 'Baile', level: 'Intermedio', img: 'https://images.unsplash.com/photo-1524594152303-9fd13543fe6e?w=800&q=80', isNew: false },
            { id: 'p1', title: 'Pilates Power', trainer: 'Sarah', duration: 30, kcal: 140, type: 'Pilates', level: 'Intermedio', img: 'https://images.unsplash.com/photo-1518310383802-640c2de311b2?w=800&q=80', isNew: false },
            { id: 'c3', title: 'Bici Estática', trainer: 'Kym', duration: 45, kcal: 500, type: 'Cardio', level: 'Intermedio', img: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=800&q=80', isNew: false },
            { id: 'y2', title: 'Yoga Flow', trainer: 'Molly', duration: 45, kcal: 200, type: 'Yoga', level: 'Avanzado', img: 'https://images.unsplash.com/photo-1552196563-1d691d45490d?w=800&q=80', isNew: true },
            { id: 'f3', title: 'Piernas de Acero', trainer: 'Kyle', duration: 20, kcal: 180, type: 'Fuerza', level: 'Avanzado', img: 'https://images.unsplash.com/photo-1434608519344-49d77a699ded?w=800&q=80', isNew: false },
        ];

        // --- RUTAS DB ---
        const ROUTES_DB = [
            { id: 'r_strength', title: 'Semana de Fuerza', count: '4 Rutinas', type: 'Fuerza', img: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=800&q=80', workouts: ['f1', 'f3', 'p1', 'c1'] },
            { id: 'r_relax', title: 'Mente y Calma', count: '3 Rutinas', type: 'Relax', img: 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=800&q=80', workouts: ['y1', 'm1', 'y2'] },
            { id: 'r_cardio', title: 'Quema Grasas', count: '3 Rutinas', type: 'Cardio', img: 'https://images.unsplash.com/photo-1538805060512-e28281313317?w=800&q=80', workouts: ['c1', 'c3', 'b1'] }
        ];

        // --- ATOMIC COMPONENTS ---

        // Toast Component for Feedback
        const Toast = ({ message, visible }) => {
            if (!visible) return null;
            return (
                <div className="fixed top-12 left-1/2 transform -translate-x-1/2 z-[100] bg-white/20 backdrop-blur-md border border-white/10 px-6 py-3 rounded-full shadow-2xl animate-toast flex items-center gap-3">
                    <span className="material-symbols-rounded text-primary">check_circle</span>
                    <span className="text-white text-sm font-semibold whitespace-nowrap">{message}</span>
                </div>
            );
        };

        const ActivityRing = ({ radius, stroke, progress, color, delay = 0 }) => {
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const safeProgress = Math.min(progress, 100); 
            const strokeDashoffset = circumference - (safeProgress / 100) * circumference;
            const [offset, setOffset] = useState(circumference);
            useEffect(() => { setTimeout(() => setOffset(strokeDashoffset), 100 + delay); }, [strokeDashoffset, delay]);
            return (
                <div className="relative flex items-center justify-center">
                    <svg height={radius * 2} width={radius * 2} className="transform -rotate-90 absolute transition-all duration-1000">
                        <circle stroke={color} strokeOpacity="0.15" strokeWidth={stroke} fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                        <circle stroke={color} strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset: offset, transition: 'stroke-dashoffset 1.2s cubic-bezier(0.34, 1.56, 0.64, 1)' }} strokeLinecap="round" fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                    </svg>
                </div>
            );
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-ios-card rounded-[16px] active:scale-[0.98] active:bg-[#262629] transition-all duration-200 overflow-hidden ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled=false }) => {
            const base = "w-full py-3.5 rounded-[14px] font-bold text-[17px] active:opacity-80 transition-opacity flex items-center justify-center gap-2";
            const variants = { 
                primary: "bg-primary text-black shadow-lg", 
                secondary: "bg-ios-card text-white border border-white/10", 
                ghost: "bg-transparent text-ios-blue", 
                danger: "bg-ios-card text-ios-red border border-ios-red/20",
                apple: "bg-white text-black hover:bg-gray-100",
                google: "bg-white text-black hover:bg-gray-100 border border-gray-300"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className} ${disabled ? 'opacity-50' : ''}`}>{children}</button>;
        };

        const Header = ({ title, onBack, rightAction, isLarge = false }) => (
            <div className={`sticky top-0 z-30 glass-header px-4 flex items-center justify-between transition-all duration-300 ${isLarge ? 'h-[100px] items-end pb-3' : 'h-[50px]'}`}>
                <div className="flex-1 flex items-center">
                    {onBack && <button onClick={onBack} className="flex items-center text-ios-blue -ml-2 active:opacity-50"><span className="material-symbols-rounded text-3xl">chevron_left</span><span className="text-[17px]">Atrás</span></button>}
                </div>
                {!isLarge && <h1 className="text-[17px] font-semibold absolute left-1/2 transform -translate-x-1/2 text-white">{title}</h1>}
                {isLarge && <h1 className="text-[34px] font-bold tracking-tight absolute left-4 bottom-2 text-white">{title}</h1>}
                <div className="flex-1 flex justify-end">{rightAction}</div>
            </div>
        );

        const ListItem = ({ icon, label, value, onClick, hasArrow = true, isDestructive = false, iconColor = "bg-ios-gray" }) => (
            <div onClick={onClick} className="flex items-center gap-3 p-4 bg-ios-card border-b border-white/10 last:border-0 active:bg-[#262629] cursor-pointer transition-colors">
                {icon && <div className={`w-7 h-7 rounded-[6px] flex items-center justify-center ${iconColor} text-white`}><span className="material-symbols-rounded text-[18px]">{icon}</span></div>}
                <div className="flex-1 flex justify-between items-center">
                    <span className={`text-[17px] ${isDestructive ? 'text-ios-red' : 'text-white'}`}>{label}</span>
                    <div className="flex items-center gap-2">{value && <span className="text-ios-gray text-[17px]">{value}</span>}{hasArrow && <span className="material-symbols-rounded text-ios-gray/40 text-[20px]">chevron_right</span>}</div>
                </div>
            </div>
        );

        // Updated ToggleItem to support 'icon' prop for Menu Enhancements
        const ToggleItem = ({ label, checked, onChange, icon }) => (
            <div className="flex items-center justify-between p-4 bg-ios-card border-b border-white/10 last:border-0">
                <div className="flex items-center gap-3">
                    {icon && <div className="w-7 h-7 rounded-[6px] flex items-center justify-center bg-ios-gray text-white"><span className="material-symbols-rounded text-[18px]">{icon}</span></div>}
                    <span className="text-[17px] text-white">{label}</span>
                </div>
                <div className={`relative inline-block w-12 h-7 transition-colors duration-200 ease-in-out rounded-full cursor-pointer ${checked ? 'bg-green-500' : 'bg-[#39393D]'}`} onClick={() => onChange(!checked)}>
                    <span className={`absolute left-0.5 top-0.5 inline-block w-6 h-6 transform transition-transform duration-200 ease-in-out bg-white rounded-full shadow-sm ${checked ? 'translate-x-5' : 'translate-x-0'}`}/>
                </div>
            </div>
        );

        const SegmentedControl = ({ options, selected, onSelect }) => (
            <div className="bg-[#2C2C2E] p-0.5 rounded-[9px] flex mb-4">
                {options.map(opt => (
                    <button key={opt} onClick={() => onSelect(opt)} className={`flex-1 py-1.5 text-[13px] font-semibold rounded-[7px] transition-all shadow-sm ${selected === opt ? 'bg-[#636366] text-white' : 'text-ios-gray hover:text-white'}`}>{opt}</button>
                ))}
            </div>
        );

        // --- VIEWS ---

        // 0. AUTH VIEW
        const AuthView = ({ setView, onLogin }) => {
            const [step, setStep] = useState(0); 
            const [data, setData] = useState({ goal: '', level: '', name: '', email: '', pass: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const update = (k, v) => { setData({...data, [k]: v}); setError(''); };

            // Password Strength Helper
            const getStrength = (pass) => {
                if (!pass) return { label: '', color: '' };
                const hasNumber = /\d/.test(pass);
                const len = pass.length;
                if (len < 6) return { label: 'Débil', color: 'text-red-500' };
                if (len >= 6 && len <= 9) return { label: 'Normal', color: 'text-orange-500' };
                if (len > 9 && hasNumber) return { label: 'Fuerte', color: 'text-green-500' };
                return { label: 'Normal', color: 'text-orange-500' }; 
            };

            const strength = getStrength(data.pass);

            const handleSocialAuth = (provider) => {
                setLoading(true);
                setTimeout(() => {
                    setLoading(false);
                    onLogin({
                        name: provider === 'google' ? 'Usuario Google' : 'Usuario Apple',
                        email: `user@${provider}.com`,
                        password: 'social_login_pass', 
                        avatar: null, 
                        goal: 'Mantenerme activo', 
                        level: 'Intermedio'
                    }, true);
                }, 1500);
            };

            const validateEmail = (email) => {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            };

            const handleRegister = () => {
                if (!data.name || !data.email || !data.pass) { setError('Todos los campos son obligatorios.'); return; }
                if (!validateEmail(data.email)) { setError('El email no es válido.'); return; }
                
                setStep(5);
                setTimeout(() => onLogin({ ...data, password: data.pass }, true), 2000); 
            };

            const handleLoginSubmit = () => {
                if (!data.email || !data.pass) { setError('Introduce tu email y contraseña.'); return; }
                setStep(5);
                setTimeout(() => onLogin({ name: 'Maria', ...data, password: data.pass }, false), 1500); 
            };

            if (step === 0) return (
                <div className="flex flex-col min-h-screen bg-black items-center justify-center p-6 relative overflow-hidden animate-fade-in">
                    <div className="absolute top-0 left-0 w-full h-3/4 bg-gradient-to-b from-primary/10 via-transparent to-transparent pointer-events-none"></div>
                    <div className="flex-1 flex flex-col items-center justify-center gap-6 w-full max-w-sm z-10">
                        <div className="relative w-32 h-32 animate-scale-in">
                             <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90 filter drop-shadow-[0_0_30px_rgba(164,255,0,0.3)]">
                                <circle cx="50" cy="50" r="40" stroke="#FA114F" strokeWidth="10" fill="none" strokeDasharray="251" strokeDashoffset="50" strokeLinecap="round" />
                                <circle cx="50" cy="50" r="28" stroke="#A4FF00" strokeWidth="10" fill="none" strokeDasharray="175" strokeDashoffset="40" strokeLinecap="round" />
                                <circle cx="50" cy="50" r="16" stroke="#00F5EA" strokeWidth="10" fill="none" strokeDasharray="100" strokeDashoffset="20" strokeLinecap="round" />
                             </svg>
                        </div>
                        <div className="text-center">
                            <h1 className="text-5xl font-black tracking-tighter text-white mb-2">Fitness<span className="text-primary">+</span></h1>
                            <p className="text-ios-gray text-lg font-medium">Cierra tus anillos.</p>
                        </div>
                    </div>

                    {loading ? (
                         <div className="w-full max-w-sm mb-20 flex flex-col items-center">
                             <div className="w-8 h-8 border-4 border-zinc-700 border-t-primary rounded-full animate-spin mb-4"></div>
                             <p className="text-ios-gray">Autenticando...</p>
                         </div>
                    ) : (
                        <div className="w-full max-w-sm space-y-3 mb-8 z-10">
                            <button onClick={() => handleSocialAuth('apple')} className="btn-social btn-apple gap-2"><i className="fab fa-apple text-xl"></i> Continuar con Apple</button>
                            <button onClick={() => handleSocialAuth('google')} className="btn-social btn-google gap-2"><img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-5 h-5"/> Continuar con Google</button>
                            
                            <div className="flex items-center gap-4 my-2 opacity-50">
                                <div className="h-px bg-white/30 flex-1"></div><span className="text-xs text-white">O USAR EMAIL</span><div className="h-px bg-white/30 flex-1"></div>
                            </div>
                            
                            <Button onClick={() => setStep(1)} variant="secondary">Registrarse</Button>
                            <div onClick={() => setStep(4)} className="text-center text-sm text-ios-blue font-semibold cursor-pointer py-2 active:opacity-50">Iniciar Sesión</div>
                        </div>
                    )}
                </div>
            );

            if (step === 1) return (
                <div className="flex flex-col min-h-screen bg-black p-6 animate-slide-in-right">
                    <Header title="Paso 1 de 3" onBack={() => setStep(0)} />
                    <div className="pt-4 mb-8"><h2 className="text-3xl font-bold text-white mb-2">¿Cuál es tu objetivo?</h2></div>
                    <div className="space-y-3">{['Perder peso', 'Ganar músculo', 'Mantenerme activo', 'Reducir estrés'].map(opt => (<Button key={opt} variant="secondary" onClick={() => { update('goal', opt); setStep(2); }} className="justify-between px-5 h-16">{opt} <span className="material-symbols-rounded">chevron_right</span></Button>))}</div>
                </div>
            );

            if (step === 2) return (
                <div className="flex flex-col min-h-screen bg-black p-6 animate-slide-in-right">
                    <Header title="Paso 2 de 3" onBack={() => setStep(1)} />
                    <div className="pt-4 mb-8"><h2 className="text-3xl font-bold text-white mb-2">Tu nivel</h2></div>
                    <div className="space-y-3">{['Principiante', 'Intermedio', 'Avanzado'].map(opt => (<Button key={opt} variant="secondary" onClick={() => { update('level', opt); setStep(3); }} className="justify-between px-5 h-16">{opt} <span className="material-symbols-rounded">chevron_right</span></Button>))}</div>
                </div>
            );

            if (step === 3) return (
                <div className="flex flex-col min-h-screen bg-black p-6 animate-slide-in-right">
                    <Header title="Crear Cuenta" onBack={() => setStep(2)} />
                    <div className="pt-4 mb-8"><h2 className="text-3xl font-bold text-white mb-2">Tus datos</h2></div>
                    <div className="space-y-4 mb-8">
                        <input type="text" placeholder="Nombre" value={data.name} onChange={e=>update('name',e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl border border-transparent focus:border-primary transition-colors" />
                        <input type="email" placeholder="Email" value={data.email} onChange={e=>update('email',e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl border border-transparent focus:border-primary transition-colors" />
                        
                        <div>
                            <input type="password" placeholder="Contraseña" value={data.pass} onChange={e=>update('pass',e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl border border-transparent focus:border-primary transition-colors" />
                            {data.pass && (
                                <div className="mt-2 flex items-center gap-2 animate-fade-in">
                                    <div className={`h-1.5 flex-1 rounded-full bg-gray-700 overflow-hidden`}>
                                        <div className={`h-full transition-all duration-300 ${strength.label === 'Débil' ? 'w-1/3 bg-red-500' : strength.label === 'Normal' ? 'w-2/3 bg-orange-500' : 'w-full bg-green-500'}`}></div>
                                    </div>
                                    <span className={`text-xs font-bold uppercase ${strength.color}`}>{strength.label}</span>
                                </div>
                            )}
                        </div>

                        {error && <p className="text-red-500 text-sm px-2 animate-bounce">{error}</p>}
                    </div>
                    <Button onClick={handleRegister}>Crear Cuenta</Button>
                </div>
            );

             if (step === 4) return (
                <div className="flex flex-col min-h-screen bg-black p-6 animate-slide-in-right">
                    <Header title="Iniciar Sesión" onBack={() => setStep(0)} />
                    <div className="pt-10 mb-8"><h2 className="text-3xl font-bold text-white mb-2">Bienvenido de nuevo</h2></div>
                    <div className="space-y-4 mb-8">
                        <input type="email" placeholder="Email" value={data.email} onChange={e=>update('email',e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl border border-transparent focus:border-primary transition-colors" />
                        <input type="password" placeholder="Contraseña" value={data.pass} onChange={e=>update('pass',e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl border border-transparent focus:border-primary transition-colors" />
                        {error && <p className="text-red-500 text-sm px-2 animate-bounce">{error}</p>}
                    </div>
                    <Button onClick={handleLoginSubmit}>Entrar</Button>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen bg-black items-center justify-center p-6 animate-fade-in">
                    <div className="w-16 h-16 border-4 border-zinc-800 border-t-primary rounded-full animate-spin mb-4"></div>
                    <h2 className="text-xl font-bold text-white">{step === 3 ? "Personalizando tu experiencia..." : "Iniciando sesión..."}</h2>
                </div>
            );
        };

        // 1. DASHBOARD VIEW
        const DashboardView = ({ setView, user, stats, history, plan, target }) => {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Buenos días" : hour < 20 ? "Buenas tardes" : "Buenas noches";
            const today = new Date().toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' });
            const movePct = Math.min((stats.move / target.move) * 100, 100);
            const exPct = Math.min((stats.exercise / target.exercise) * 100, 100);
            const standPct = Math.min((stats.stand / target.stand) * 100, 100);

            return (
                <div className="flex flex-col min-h-screen bg-black pb-28 animate-fade-in pt-14">
                    <div className="px-5 mb-6 flex justify-between items-end">
                        <div>
                            <p className="text-ios-gray text-[13px] font-bold uppercase tracking-wide mb-1">{today}</p>
                            <h1 className="text-white text-[34px] font-bold tracking-tight leading-none">{greeting}, {user.name.split(' ')[0]}</h1>
                        </div>
                        <div onClick={() => setView('settings')} className="w-10 h-10 rounded-full bg-ios-card border border-white/10 flex items-center justify-center cursor-pointer hover:bg-white/20 transition-all active:scale-95 overflow-hidden shadow-lg">
                            {user.avatar ? <img src={user.avatar} className="w-full h-full object-cover"/> : <span className="text-lg font-bold text-white uppercase">{user.name.charAt(0)}</span>}
                        </div>
                    </div>

                    <div className="px-5 mb-8">
                        <Card onClick={() => setView('activityDetail', { stats, target })} className="p-5 bg-black border border-white/15 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.7)]">
                            <div className="flex justify-between items-center mb-4"><h2 className="text-[19px] font-semibold text-white">Actividad</h2><span className="material-symbols-rounded text-ios-gray/50">arrow_forward_ios</span></div>
                            <div className="flex gap-6 items-center">
                                <div className="relative w-32 h-32 flex-shrink-0">
                                    <div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={64} stroke={11} progress={movePct} color="#FA114F" /></div>
                                    <div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={48} stroke={11} progress={exPct} color="#A4FF00" delay={100} /></div>
                                    <div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={32} stroke={11} progress={standPct} color="#00F5EA" delay={200} /></div>
                                </div>
                                <div className="flex flex-col justify-center gap-3 w-full">
                                    <div><span className="text-[11px] font-bold uppercase text-move tracking-wider">Movimiento</span><div className="flex items-baseline gap-1"><span className="text-2xl font-mono font-bold text-white">{stats.move}</span><span className="text-xs text-ios-gray font-bold">/ {target.move} KCAL</span></div></div>
                                    <div><span className="text-[11px] font-bold uppercase text-exercise tracking-wider">Ejercicio</span><div className="flex items-baseline gap-1"><span className="text-2xl font-mono font-bold text-white">{stats.exercise}</span><span className="text-xs text-ios-gray font-bold">/ {target.exercise} MIN</span></div></div>
                                    <div><span className="text-[11px] font-bold uppercase text-stand tracking-wider">De Pie</span><div className="flex items-baseline gap-1"><span className="text-2xl font-mono font-bold text-white">{stats.stand}</span><span className="text-xs text-ios-gray font-bold">/ {target.stand} HRS</span></div></div>
                                </div>
                            </div>
                        </Card>
                    </div>

                    <div className="px-5 mb-8">
                        <div className="flex justify-between items-center mb-3"><h2 className="text-[20px] font-bold text-white">Tendencias</h2></div>
                        <div className="grid grid-cols-2 gap-3">
                             <Card className="p-4 bg-ios-card flex flex-col gap-1 border border-white/5"><p className="text-[13px] font-bold text-ios-gray uppercase">Movimiento</p><div className="flex items-end gap-2"><span className="text-2xl font-mono font-bold text-white">{stats.move > 0 ? stats.move : '-'}</span><span className="text-[10px] text-ios-gray mb-1 font-bold">KCAL/DÍA</span></div></Card>
                             <Card className="p-4 bg-ios-card flex flex-col gap-1 border border-white/5"><p className="text-[13px] font-bold text-ios-gray uppercase">Ejercicio</p><div className="flex items-end gap-2"><span className="text-2xl font-mono font-bold text-white">{stats.exercise > 0 ? stats.exercise : '-'}</span><span className="text-[10px] text-ios-gray mb-1 font-bold">MIN/DÍA</span></div></Card>
                        </div>
                    </div>

                    <div className="px-5">
                        <div className="flex justify-between items-center mb-3"><h2 className="text-[20px] font-bold text-white">Entrenamientos</h2>{history.length > 0 && <span className="text-primary text-[15px] font-semibold cursor-pointer active:opacity-50" onClick={() => setView('history')}>Ver todo</span>}</div>
                        {history.length === 0 ? (
                            <div className="p-8 text-center bg-ios-card rounded-[14px] border border-white/5 flex flex-col items-center gap-4">
                                <div className="w-14 h-14 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-1 shadow-[0_0_20px_rgba(164,255,0,0.1)] animate-pulse-ring"><span className="material-symbols-rounded text-3xl">play_arrow</span></div>
                                <div><p className="text-white font-bold text-lg">Empieza a moverte</p><p className="text-ios-gray text-sm mt-1">Completa tu primer entrenamiento.</p></div>
                                <Button variant="primary" onClick={() => setView('fitness')} className="py-2 text-sm h-10 px-6 mt-2">Ir a Fitness+</Button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {history.slice(0, 3).map((workout, idx) => (
                                    <Card key={idx} className="flex items-center p-4 gap-4 bg-ios-card border border-white/5" onClick={() => setView('workoutDetail', workout)}>
                                        <div className="w-12 h-12 rounded-xl bg-white/5 flex items-center justify-center text-primary"><span className="material-symbols-rounded text-2xl">check</span></div>
                                        <div className="flex-1"><p className="font-bold text-[16px] text-white">{workout.title}</p><p className="text-xs text-ios-gray mt-0.5 font-medium">{workout.kcal} kcal • {workout.time} min</p></div>
                                        <span className="material-symbols-rounded text-ios-gray/50">chevron_right</span>
                                    </Card>
                                ))}
                            </div>
                        )}
                    </div>

                    {plan.length > 0 && (
                        <div className="px-5 mt-8">
                            <h2 className="text-[20px] font-bold mb-3 text-white">Para ti: {user.goal}</h2>
                            <div className="flex gap-4 overflow-x-auto no-scrollbar pb-4">
                                {plan.map((item) => (
                                    <div key={item.id} onClick={() => setView('activeWorkout', item)} className="min-w-[220px] flex flex-col gap-3 cursor-pointer active:scale-95 transition-transform group">
                                        <div className="w-full h-32 rounded-[12px] bg-cover bg-center relative overflow-hidden shadow-md" style={{backgroundImage: `url("${item.img}")`}}>
                                            <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all"></div>
                                            <span className="absolute bottom-2 right-2 bg-black/60 backdrop-blur px-2 py-0.5 rounded text-[10px] font-bold text-white">{item.duration} min</span>
                                        </div>
                                        <div><p className="font-semibold text-white text-sm leading-tight">{item.title}</p><p className="text-xs text-ios-gray mt-1 font-medium">{item.type} • {item.trainer}</p></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 2. FITNESS+ VIEW
        const FitnessPlusView = ({ setView }) => {
            const [query, setQuery] = useState('');
            const [filter, setFilter] = useState(null);
            
            const filtered = useMemo(() => {
                let d = EXERCISE_DB;
                if(query) d = d.filter(w => w.title.toLowerCase().includes(query.toLowerCase()));
                if(filter) d = d.filter(w => w.type === filter || w.level === filter); 
                return d;
            }, [query, filter]);

            const Pill = ({ l }) => <button onClick={()=>setFilter(filter===l?null:l)} className={`px-4 py-2 rounded-full border text-[13px] font-bold whitespace-nowrap transition-colors ${filter===l?'bg-white text-black border-white':'bg-[#2C2C2E] border-white/10 text-white hover:bg-[#3A3A3C]'}`}>{l}</button>;

            const startRoute = (route) => {
                const firstWorkoutId = route.workouts[0];
                const workout = EXERCISE_DB.find(w => w.id === firstWorkoutId);
                if(workout) {
                    setView('activeWorkout', workout);
                }
            };

            return (
                <div className="flex flex-col min-h-screen bg-black pb-28 pt-12 animate-fade-in">
                    <div className="px-5 sticky top-0 bg-black/95 z-20 pb-4 pt-2 border-b border-white/5">
                        <h1 className="text-3xl font-bold mb-4 text-white">Fitness+</h1>
                        <div className="relative mb-4">
                            <span className="material-symbols-rounded absolute left-3 top-3 text-ios-gray">search</span>
                            <input type="text" placeholder="Buscar entrenamientos..." value={query} onChange={e=>setQuery(e.target.value)} className="w-full bg-ios-card rounded-[10px] py-3 pl-10 pr-4 text-white placeholder-ios-gray focus:ring-1 focus:ring-primary outline-none transition-shadow" />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            {['Principiante','Avanzado','Yoga','HIIT','Fuerza', 'Baile'].map(f=><Pill key={f} l={f}/>)}
                        </div>
                    </div>
                    
                    <div className="px-5 pt-6 pb-10">
                        {!query && !filter && (
                            <div className="mb-8">
                                <h2 className="text-xl font-bold text-white mb-4">Rutas de Entrenamiento</h2>
                                <div className="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                                    {ROUTES_DB.map(route => (
                                        <div key={route.id} onClick={() => startRoute(route)} className="min-w-[260px] relative h-40 rounded-[14px] overflow-hidden cursor-pointer active:scale-95 transition-transform">
                                            <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: `url("${route.img}")`}}></div>
                                            <div className="absolute inset-0 bg-gradient-to-r from-black/80 to-transparent"></div>
                                            <div className="absolute inset-0 p-4 flex flex-col justify-end">
                                                <p className="text-primary text-[10px] font-bold uppercase mb-1">{route.count}</p>
                                                <h3 className="text-white font-bold text-lg leading-tight">{route.title}</h3>
                                                <p className="text-ios-gray text-xs mt-1">{route.type}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <h2 className="text-xl font-bold text-white mb-4">{query || filter ? 'Resultados' : 'Nuevos Entrenamientos'}</h2>
                        {filtered.length===0 ? <div className="text-center text-ios-gray mt-20 flex flex-col items-center"><span className="material-symbols-rounded text-4xl mb-2 opacity-50">search_off</span><p>No hay resultados</p></div> : 
                        <div className="grid grid-cols-2 gap-4">
                            {filtered.map(item => (
                                <div key={item.id} onClick={() => setView('activeWorkout', item)} className="bg-ios-card rounded-[14px] overflow-hidden cursor-pointer active:scale-95 transition-transform group border border-white/5 hover:border-white/20">
                                    <div className="h-32 bg-cover bg-center relative" style={{backgroundImage: `url("${item.img}")`}}>
                                        {item.isNew && <span className="absolute top-2 left-2 bg-primary text-black px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide shadow-sm">Nuevo</span>}
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                    </div>
                                    <div className="p-3">
                                        <p className="font-bold text-sm truncate text-white">{item.title}</p>
                                        <p className="text-[11px] text-ios-gray font-medium mt-0.5 uppercase tracking-wide">{item.type} • {item.duration}m</p>
                                    </div>
                                </div>
                            ))}
                        </div>}
                    </div>
                </div>
            );
        };

        // 3. SHARING VIEW (UPDATED: VISUAL POLISH ON ROUTES)
        const SharingView = ({ setView }) => {
            const [segment, setSegment] = useState('Actividad');
            const [friends, setFriends] = useState([
                { id: 1, name: 'Carlos', text: 'completó 5 km', time: '5 min', img: 'https://randomuser.me/api/portraits/men/32.jpg', likes: 12, cheered: false },
                { id: 2, name: 'Ana', text: 'cerró sus anillos', time: '30 min', img: 'https://randomuser.me/api/portraits/women/44.jpg', likes: 24, cheered: false },
                { id: 3, name: 'Laura', text: 'entreno de fuerza', time: '1h', img: 'https://randomuser.me/api/portraits/women/68.jpg', likes: 8, cheered: false }
            ]);
            
            const [toastMsg, setToastMsg] = useState('');
            
            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(''), 3000);
            };

            const handleCheer = (id) => {
                setFriends(prev => prev.map(f => {
                    if (f.id === id) {
                        return { ...f, cheered: !f.cheered, likes: f.cheered ? f.likes - 1 : f.likes + 1 };
                    }
                    return f;
                }));
            };

            const handleGlobalShare = async () => {
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Fitness+',
                            text: '¡Mira mi progreso en Fitness+!',
                            url: window.location.href
                        });
                    } catch (err) { console.log('Error sharing:', err); }
                } else {
                    showToast('Enlace de perfil copiado al portapapeles');
                }
            };

            const startRoute = (route) => {
                const firstWorkoutId = route.workouts[0];
                const workout = EXERCISE_DB.find(w => w.id === firstWorkoutId);
                if(workout) {
                    setView('activeWorkout', workout);
                }
            };

            return (
                <div className="flex flex-col min-h-screen bg-black pb-28 animate-fade-in pt-12">
                     <Toast message={toastMsg} visible={!!toastMsg} />
                     <div className="px-5 mb-4 flex justify-between items-center sticky top-0 bg-black/95 z-10 py-2 border-b border-white/5">
                        <h1 className="text-[34px] font-bold text-white">Compartir</h1>
                        <div onClick={handleGlobalShare} className="w-8 h-8 rounded-full bg-ios-card flex items-center justify-center cursor-pointer active:opacity-50"><span className="material-symbols-rounded text-primary text-sm">ios_share</span></div>
                    </div>
                    <div className="px-5">
                        <SegmentedControl options={['Actividad', 'Desafíos']} selected={segment} onSelect={setSegment} />
                        
                        {segment === 'Actividad' && (
                            <div className="space-y-6 animate-fade-in">
                                <div onClick={() => setView('activityDetail')} className="active:opacity-70 transition-opacity cursor-pointer">
                                    <h3 className="text-xs font-bold text-ios-gray uppercase mb-2 ml-3">Tus Anillos</h3>
                                    <Card className="p-4 flex items-center justify-between border border-white/5">
                                        <div className="flex items-center gap-4"><div className="relative w-14 h-14"><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={28} stroke={4} progress={75} color="#FF005C" /></div><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={21} stroke={4} progress={50} color="#90E600" /></div><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={14} stroke={4} progress={85} color="#00E0E0" /></div></div><div><p className="font-bold text-white">Yo</p></div></div>
                                        <span className="material-symbols-rounded text-ios-gray/40">chevron_right</span>
                                    </Card>
                                </div>
                                <div className="space-y-3">
                                    <h3 className="text-xs font-bold text-ios-gray uppercase ml-3">Feed</h3>
                                    {friends.map((f) => (
                                        <Card key={f.id} className="p-4 flex gap-4 border border-white/5">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1"><div className="w-6 h-6 rounded-full bg-cover bg-center border border-white/10" style={{backgroundImage: `url("${f.img}")`}}></div><span className="font-bold text-sm text-white">{f.name}</span><span className="text-xs text-ios-gray">• {f.time}</span></div>
                                                <p className="font-medium text-sm leading-tight mb-3 text-gray-300">{f.text}</p>
                                                <div className="flex items-center justify-between">
                                                    <button onClick={() => handleCheer(f.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-bold transition-all ${f.cheered ? 'bg-primary text-black' : 'bg-white/10 text-white hover:bg-white/20'}`}>
                                                        <span className={`material-symbols-rounded text-[14px] ${f.cheered ? 'icon-filled' : ''}`}>thumb_up</span> {f.cheered ? 'ANIMADO' : 'ANIMAR'}
                                                    </button>
                                                    <span className="text-xs text-ios-gray font-medium">{f.likes} likes</span>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {segment === 'Desafíos' && (
                            <div className="space-y-4 animate-fade-in mt-2">
                                <div className="bg-gradient-to-r from-purple-900/40 to-blue-900/40 p-4 rounded-2xl border border-white/10 mb-4">
                                    <div className="flex gap-3">
                                        <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center"><span className="material-symbols-rounded text-yellow-400">emoji_events</span></div>
                                        <div>
                                            <h3 className="font-bold text-white">Compite con amigos</h3>
                                            <p className="text-xs text-ios-gray mt-1">Invita a tus amigos a completar una ruta contigo.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {ROUTES_DB.map(route => (
                                    <Card key={route.id} className="bg-ios-card overflow-hidden border border-white/5 flex flex-row items-center p-3 gap-4">
                                        {/* THUMBNAIL IMAGE LEFT */}
                                        <img src={route.img} className="w-20 h-20 rounded-lg object-cover bg-gray-800" />
                                        
                                        <div className="flex-1">
                                            <p className="text-primary text-[10px] font-bold uppercase mb-0.5">{route.count}</p>
                                            <h3 className="text-lg font-bold text-white leading-tight mb-1">{route.title}</h3>
                                            
                                            <div className="flex -space-x-2 mt-2 mb-2">
                                                {[1,2,3].map(i => <div key={i} className="w-5 h-5 rounded-full border border-[#2C2C2E] bg-gray-600"></div>)}
                                            </div>
                                        </div>
                                        
                                        <button onClick={() => startRoute(route)} className="bg-white/10 text-white hover:bg-white/20 px-3 py-3 rounded-full active:scale-95 transition-transform flex items-center justify-center">
                                            <span className="material-symbols-rounded text-2xl">play_arrow</span>
                                        </button>
                                    </Card>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. SETTINGS VIEW (UPDATED: SECURITY MODAL LOGIC & VISUAL ICONS)
        const SettingsView = ({ setView, goBack, user, updateUser, target, updateTarget }) => {
            const [notif, setNotif] = useState(true);
            const [health, setHealth] = useState(true);
            const [units, setUnits] = useState('km');
            const [privacyPublic, setPrivacyPublic] = useState(false);
            const [privacyShare, setPrivacyShare] = useState(true);
            const [twoFactor, setTwoFactor] = useState(true);

            // UI States
            const [modal, setModal] = useState(null); 
            const [toastMsg, setToastMsg] = useState('');
            
            // Edit States
            const [newName, setNewName] = useState(user.name);
            const [newMove, setNewMove] = useState(target.move);
            const [newEx, setNewEx] = useState(target.exercise);
            const [newStand, setNewStand] = useState(target.stand);
            
            // Password State
            const [currentPass, setCurrentPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');

            const fileInputRef = useRef(null);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(''), 3000);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        updateUser({ avatar: reader.result });
                        showToast('Foto de perfil actualizada');
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Actions
            const handleUnitsToggle = () => {
                const newUnit = units === 'km' ? 'mi' : 'km';
                setUnits(newUnit);
                showToast(`Unidades cambiadas a ${newUnit === 'km' ? 'Kilómetros' : 'Millas'}`);
            };

            const handleDeviceScan = () => {
                showToast('Buscando dispositivos...');
                setTimeout(() => {
                    showToast('Apple Watch Series 9 conectado');
                }, 2000);
            };

            const handleHealthToggle = (val) => {
                setHealth(val);
                showToast(val ? 'Sincronización con Salud activada' : 'Sincronización pausada');
            };

            const handleNotifToggle = (val) => {
                setNotif(val);
                showToast(val ? 'Notificaciones activadas' : 'Notificaciones desactivadas');
            };
            
            const handlePasswordChange = () => {
                // Validation Logic
                if (!currentPass || !newPass || !confirmPass) {
                    alert("Por favor completa todos los campos."); 
                    return;
                }

                // Check Current Password (Strict check against user state)
                if (currentPass !== user.password) {
                    alert("La contraseña actual es incorrecta.");
                    return;
                }

                // Check Match
                if (newPass !== confirmPass) {
                    alert("Las nuevas contraseñas no coinciden.");
                    return;
                }
                
                // Update
                updateUser({ password: newPass });
                showToast('Contraseña actualizada correctamente');
                setModal(null);
                setCurrentPass(''); setNewPass(''); setConfirmPass('');
            };

            // Modal Renderer
            if (modal === 'profile') return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Editar Perfil" onBack={() => setModal(null)} rightAction={<span className="text-ios-blue font-semibold cursor-pointer" onClick={() => { updateUser({name: newName}); setModal(null); showToast('Perfil guardado'); }}>Guardar</span>} />
                    <div className="p-5 space-y-6">
                        <div className="flex flex-col items-center gap-4 mt-4">
                            <div className="relative group">
                                <div onClick={() => fileInputRef.current.click()} className="w-28 h-28 rounded-full overflow-hidden border-4 border-ios-card cursor-pointer active:opacity-70 relative">
                                    {user.avatar ? <img src={user.avatar} className="w-full h-full object-cover"/> : <div className="w-full h-full bg-gray-800 flex items-center justify-center"><span className="material-symbols-rounded text-4xl text-gray-500">add_a_photo</span></div>}
                                    <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span className="text-white text-xs font-bold">EDITAR</span></div>
                                </div>
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                            </div>
                            <p className="text-ios-blue text-sm font-medium">Cambiar foto de perfil</p>
                        </div>
                        <div><label className="text-xs text-ios-gray font-bold uppercase ml-3 mb-2 block">Nombre</label><input type="text" value={newName} onChange={e=>setNewName(e.target.value)} className="w-full bg-ios-card text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-ios-blue border border-transparent focus:border-ios-blue transition-all" /></div>
                    </div>
                </div>
            );

            if (modal === 'goals') return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Objetivos" onBack={() => setModal(null)} rightAction={<span className="text-ios-blue font-semibold cursor-pointer" onClick={() => { updateTarget({move: newMove, exercise: newEx, stand: newStand}); setModal(null); showToast('Objetivos actualizados'); }}>Guardar</span>} />
                    <div className="p-5 space-y-6">
                        <div><label className="text-xs text-move font-bold uppercase ml-3 mb-2 block">Movimiento (KCAL)</label><input type="number" value={newMove} onChange={e=>setNewMove(Number(e.target.value))} className="w-full bg-ios-card text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-move font-mono text-lg" /></div>
                        <div><label className="text-xs text-exercise font-bold uppercase ml-3 mb-2 block">Ejercicio (MIN)</label><input type="number" value={newEx} onChange={e=>setNewEx(Number(e.target.value))} className="w-full bg-ios-card text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-exercise font-mono text-lg" /></div>
                        <div><label className="text-xs text-stand font-bold uppercase ml-3 mb-2 block">De Pie (HRS)</label><input type="number" value={newStand} onChange={e=>setNewStand(Number(e.target.value))} className="w-full bg-ios-card text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-stand font-mono text-lg" /></div>
                    </div>
                </div>
            );

            if (modal === 'security') return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Seguridad" onBack={() => setModal(null)} />
                    <div className="p-5 space-y-4">
                        <p className="text-ios-gray text-sm mb-4">Gestiona la seguridad de tu cuenta.</p>
                        <div className="bg-ios-card rounded-xl overflow-hidden p-4 space-y-4">
                            <h3 className="font-bold text-white mb-2">Cambiar Contraseña</h3>
                            <div className="space-y-3">
                                <input type="password" placeholder="Contraseña actual" value={currentPass} onChange={e=>setCurrentPass(e.target.value)} className="w-full bg-[#2C2C2E] p-3 rounded-lg text-white text-sm focus:ring-1 focus:ring-ios-blue outline-none" />
                                <input type="password" placeholder="Nueva contraseña" value={newPass} onChange={e=>setNewPass(e.target.value)} className="w-full bg-[#2C2C2E] p-3 rounded-lg text-white text-sm focus:ring-1 focus:ring-ios-blue outline-none" />
                                <input type="password" placeholder="Confirmar nueva contraseña" value={confirmPass} onChange={e=>setConfirmPass(e.target.value)} className="w-full bg-[#2C2C2E] p-3 rounded-lg text-white text-sm focus:ring-1 focus:ring-ios-blue outline-none" />
                            </div>
                            <Button variant="secondary" onClick={handlePasswordChange} className="py-2 text-sm h-10 mt-2">Actualizar Contraseña</Button>
                        </div>
                        <div className="bg-ios-card rounded-xl overflow-hidden">
                            <ToggleItem label="Autenticación en dos pasos" checked={twoFactor} onChange={(v) => { setTwoFactor(v); showToast(v ? '2FA Activado' : '2FA Desactivado'); }} icon="security" />
                        </div>
                    </div>
                </div>
            );

            if (modal === 'privacy') return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Privacidad" onBack={() => setModal(null)} />
                    <div className="p-5 space-y-4">
                         <p className="text-ios-gray text-sm mb-4">Controla quién puede ver tu actividad.</p>
                         <div className="bg-ios-card rounded-xl overflow-hidden">
                            <ToggleItem label="Perfil Público" checked={privacyPublic} onChange={(v) => { setPrivacyPublic(v); showToast(v ? 'Tu perfil ahora es público' : 'Tu perfil ahora es privado'); }} icon="public" />
                            <ToggleItem label="Compartir Actividad" checked={privacyShare} onChange={(v) => { setPrivacyShare(v); showToast('Preferencias de compartir actualizadas'); }} icon="share" />
                         </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Toast message={toastMsg} visible={!!toastMsg} />
                    <Header title="Perfil" onBack={goBack} rightAction={<span className="text-ios-blue font-semibold cursor-pointer" onClick={goBack}>OK</span>} />
                    <div className="px-5 pt-6 pb-20">
                        <div className="flex flex-col items-center mb-8">
                             <div onClick={() => fileInputRef.current.click()} className="w-24 h-24 rounded-full mb-3 p-0.5 bg-gradient-to-tr from-gray-700 to-gray-500 shadow-xl cursor-pointer active:opacity-80">
                                {user.avatar ? <img src={user.avatar} className="w-full h-full rounded-full object-cover border-4 border-black" /> : <div className="w-full h-full rounded-full bg-gray-800 border-4 border-black flex items-center justify-center text-3xl uppercase font-bold text-gray-400">{user.name.charAt(0)}</div>}
                             </div>
                             <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                             <h2 className="text-2xl font-bold text-white">{user.name}</h2>
                             <p className="text-ios-gray text-sm">{user.email}</p>
                        </div>
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-xs font-bold text-ios-gray uppercase mb-2 px-4">CUENTA</h3>
                                <div className="rounded-[14px] overflow-hidden bg-ios-card">
                                    <ListItem icon="person" label="Editar Perfil" onClick={()=>{ setModal('profile') }} />
                                    <ListItem icon="bar_chart" label="Mis Objetivos" value={`${target.move}/${target.exercise}/${target.stand}`} onClick={()=>{ setModal('goals') }} />
                                    <ListItem icon="military_tech" label="Premios" onClick={() => setView('awards')} iconColor="bg-yellow-500 text-black" />
                                    <ListItem icon="security" label="Seguridad" onClick={()=>{ setModal('security') }} />
                                </div>
                            </div>
                            <div>
                                <h3 className="text-xs font-bold text-ios-gray uppercase mb-2 px-4">CONEXIONES</h3>
                                <div className="rounded-[14px] overflow-hidden bg-ios-card">
                                    <ListItem icon="watch" label="Dispositivos" value="Buscar" onClick={handleDeviceScan} />
                                    <ToggleItem label="Salud de Apple" checked={health} onChange={handleHealthToggle} icon="favorite" />
                                </div>
                            </div>
                            <div>
                                <h3 className="text-xs font-bold text-ios-gray uppercase mb-2 px-4">PREFERENCIAS</h3>
                                <div className="rounded-[14px] overflow-hidden bg-ios-card">
                                    <ToggleItem label="Notificaciones" checked={notif} onChange={handleNotifToggle} icon="notifications" />
                                    <ListItem icon="straighten" label="Unidades" value={units === 'km' ? 'Km' : 'Millas'} onClick={handleUnitsToggle} />
                                    <ListItem icon="lock" label="Privacidad" onClick={()=>{ setModal('privacy') }} />
                                </div>
                            </div>
                            <Button variant="danger" onClick={() => setView('auth')}>Cerrar Sesión</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. ACTIVITY DETAIL (UNCHANGED)
        const ActivityDetailView = ({ setView, goBack, data }) => {
            const stats = data?.stats || { move: 0, exercise: 0, stand: 0 };
            const target = data?.target || { move: 600, exercise: 30, stand: 12 };
            const mP = Math.min((stats.move/target.move)*100, 100);
            
            // Share Logic
            const handleShare = async () => {
                 if (navigator.share) {
                    await navigator.share({title: 'Mi Actividad', text: `He quemado ${stats.move} kcal hoy en Fitness+`});
                 } else {
                    alert("Enlace de actividad copiado");
                 }
            };

            return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Actividad" onBack={goBack} rightAction={<span onClick={handleShare} className="material-symbols-rounded text-ios-blue cursor-pointer">ios_share</span>} />
                    <div className="p-5 overflow-y-auto pb-20">
                        <div className="flex justify-center py-6 transform scale-100 transition-transform active:scale-105 duration-300"><div className="relative w-64 h-64 flex items-center justify-center"><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={120} stroke={20} progress={mP} color="#FF005C" /></div><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={80} stroke={20} progress={(stats.exercise/target.exercise)*100} color="#90E600" /></div><div className="absolute inset-0 flex items-center justify-center"><ActivityRing radius={40} stroke={20} progress={(stats.stand/target.stand)*100} color="#00E0E0" /></div></div></div>
                        <div className="space-y-6 mt-4">
                            <div className="grid grid-cols-2 gap-3">
                                <Card className="p-4 bg-ios-card border border-white/5"><p className="text-exercise text-[10px] font-bold mb-1 uppercase tracking-wider">Ejercicio</p><p className="text-2xl font-mono font-bold text-white">{stats.exercise} <span className="text-base text-ios-gray font-medium">MIN</span></p></Card>
                                <Card className="p-4 bg-ios-card border border-white/5"><p className="text-stand text-[10px] font-bold mb-1 uppercase tracking-wider">De Pie</p><p className="text-2xl font-mono font-bold text-white">{stats.stand} <span className="text-base text-ios-gray font-medium">HRS</span></p></Card>
                            </div>
                            <div>
                                <h3 className="text-xl font-bold mb-3 text-move">Calorías</h3>
                                <Card className="p-4 h-48 flex items-end gap-1 border-t-4 border-move bg-ios-card/50">
                                    {['00','04','08','12','16','20','24'].map((h, i) => <div key={i} className="flex-1 flex flex-col justify-end h-full gap-2"><div className="w-full bg-move transition-all duration-1000" style={{height: `${Math.random()*70+10}%`, opacity:0.6, borderRadius:'2px'}}></div><span className="text-[10px] text-ios-gray font-mono">{h}</span></div>)}
                                </Card>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. WORKOUT DETAIL (UNCHANGED)
        const WorkoutDetailView = ({ setView, goBack, data }) => {
            const w = data || {};
            const ZoneBar = ({ label, time, width, color }) => (
                <div className="flex flex-col gap-1"><div className="flex justify-between items-baseline"><p className="text-xs font-medium text-white">{label}</p><p className="text-xs text-ios-gray font-mono">{time}</p></div><div className="w-full h-1.5 bg-[#39393D] rounded-full overflow-hidden"><div className={`h-full ${color} transition-all duration-1000 ease-out`} style={{width: '0%'}} ref={el => setTimeout(()=>el&&(el.style.width=width), 100)}></div></div></div>
            );
            return (
                <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title={w.title} onBack={goBack} rightAction={<span className="material-symbols-rounded text-ios-blue cursor-pointer">ios_share</span>} />
                    <div className="p-5 pb-20">
                        <div className="flex items-center gap-4 mb-6"><div className="w-16 h-16 rounded-[18px] bg-[#30D158] flex items-center justify-center text-black shadow-[0_0_30px_rgba(48,209,88,0.2)]"><span className="material-symbols-rounded text-4xl">directions_run</span></div><div><h1 className="text-2xl font-bold text-white">{w.title}</h1><p className="text-ios-gray text-sm font-medium">{w.date || 'Hoy'} • {w.time} min</p></div></div>
                        <div className="w-full aspect-[4/3] bg-zinc-900 rounded-[14px] mb-6 relative overflow-hidden border border-white/10 shadow-lg group" style={{backgroundImage: 'url("https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=800&q=80")'}}><div className="absolute inset-0 bg-cover bg-center opacity-80 group-hover:opacity-100 transition-opacity"></div></div>
                        <div className="grid grid-cols-2 gap-px bg-white/10 rounded-[14px] overflow-hidden border border-white/5 mb-4">
                            <div className="bg-ios-card p-4"><p className="text-ios-gray text-[10px] font-bold uppercase tracking-wider">Tiempo</p><p className="text-2xl font-mono font-bold text-yellow-400">{w.time}m</p></div>
                            <div className="bg-ios-card p-4"><p className="text-ios-gray text-[10px] font-bold uppercase tracking-wider">Calorías</p><p className="text-2xl font-mono font-bold text-move">{w.kcal}</p></div>
                        </div>
                        <Card className="p-4 flex flex-col gap-4 border border-white/5">
                            <div className="flex items-center gap-2"><span className="material-symbols-rounded text-move text-sm">favorite</span><h3 className="font-bold text-sm uppercase tracking-wide text-ios-gray">Zonas de Esfuerzo</h3></div>
                            <ZoneBar label="Extremo" time="2 min" width="15%" color="bg-red-500" /><ZoneBar label="Intenso" time="12 min" width="45%" color="bg-orange-500" /><ZoneBar label="Moderado" time="18 min" width="70%" color="bg-yellow-400" />
                        </Card>
                    </div>
                </div>
            );
        };

        // 7. AWARDS VIEW (UNCHANGED)
        const AwardsView = ({ setView, goBack, history = [] }) => {
            const totalWorkouts = history.length;
            
            const isBronze = totalWorkouts >= 5;
            const isSilver = totalWorkouts >= 10;
            const isGold = totalWorkouts >= 20;

            const Award = ({ type, label, img, locked = false }) => (
                <div className="flex flex-col items-center gap-2 animate-scale-in">
                    <div className={`w-20 h-20 rounded-full ${type} ${locked ? 'award-locked' : ''} shadow-lg p-0.5 border-4 border-black/50 relative overflow-hidden group active:scale-90 transition-transform cursor-pointer`}>
                        <div className="absolute inset-0 bg-gradient-to-tr from-black/40 to-transparent z-10"></div>
                        {img ? <div className="absolute inset-0 bg-cover bg-center opacity-90 mix-blend-overlay" style={{backgroundImage: `url("${img}")`}}></div> : null}
                        {locked && <div className="absolute inset-0 flex items-center justify-center z-30"><span className="material-symbols-rounded text-white/50 text-2xl">lock</span></div>}
                        <div className="w-full h-full rounded-full border border-white/20 flex items-center justify-center relative z-20"><span className="material-symbols-rounded text-black/50 text-4xl font-bold drop-shadow-sm">military_tech</span></div>
                    </div>
                    <span className="text-[10px] font-bold text-center text-white w-20 leading-tight uppercase tracking-wide">{label}</span>
                </div>
            );

            return (
                 <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                    <Header title="Premios" onBack={goBack} />
                    <div className="p-5 pb-20">
                         <div className="mb-6">
                            <p className="text-ios-gray text-xs font-bold uppercase mb-2">Tu Nivel Actual</p>
                            <h2 className="text-2xl font-bold text-white mb-1">{isGold ? 'Nivel Oro' : isSilver ? 'Nivel Plata' : isBronze ? 'Nivel Bronce' : 'Iniciado'}</h2>
                            <div className="w-full bg-[#2C2C2E] h-2 rounded-full overflow-hidden mt-2">
                                <div className="bg-primary h-full transition-all duration-1000" style={{width: `${Math.min(100, (totalWorkouts / 20) * 100)}%`}}></div>
                            </div>
                            <p className="text-right text-xs text-ios-gray mt-1">{totalWorkouts} / 20 para Oro</p>
                         </div>

                         <SegmentedControl options={['Niveles', 'Desafíos', 'Competición']} selected={'Niveles'} onSelect={() => {}} />
                         <div className="grid grid-cols-3 gap-y-8 gap-x-4 mt-6">
                             <Award type="award-bronze" label="Nivel Bronce" locked={!isBronze} />
                             <Award type="award-silver" label="Nivel Plata" locked={!isSilver} />
                             <Award type="award-gold" label="Nivel Oro" locked={!isGold} />
                             <Award type="award-gold" label="Semana Perfecta" img="https://images.unsplash.com/photo-1552196563-1d691d45490d?w=800&q=80" />
                             <Award type="award-silver" label="Primeros 5K" img="https://images.unsplash.com/photo-1538805060512-e28281313317?w=800&q=80" />
                             <Award type="award-special" label="Yoga Master" />
                         </div>
                    </div>
                 </div>
            );
        };

        // 8. ACTIVE WORKOUT (UNCHANGED)
        const ActiveWorkoutView = ({ setView, goBack, data, onFinish }) => {
            const workout = data || { title: 'Libre', duration: 0, kcal: 0, img: '' };
            const isGuided = workout.duration > 0;
            const initialSeconds = isGuided ? workout.duration * 60 : 0;
            const [timeLeft, setTimeLeft] = useState(initialSeconds);
            const [elapsed, setElapsed] = useState(0);
            const [active, setActive] = useState(true);
            const [hr, setHr] = useState(110);

            useEffect(() => {
                let t;
                if(active) {
                    t = setInterval(() => {
                        setElapsed(e => e + 1);
                        setHr(prev => Math.max(90, Math.min(180, prev + Math.floor(Math.random() * 5) - 2))); // Random HR
                        if(isGuided) setTimeLeft(l => l > 0 ? l - 1 : 0);
                        else setTimeLeft(l => l + 1);
                    }, 1000);
                }
                return () => clearInterval(t);
            }, [active, isGuided]);

            const addTime = () => {
                if(isGuided) setTimeLeft(prev => prev + 10); 
                else setTimeLeft(prev => prev + 10); 
            };

            const finish = () => {
                const mins = Math.max(1, Math.floor(elapsed / 60));
                const kcalBurned = Math.floor(mins * (workout.kcal ? (workout.kcal/workout.duration) : 7)); 
                const result = { ...workout, duration: elapsed, time: mins, kcal: kcalBurned, date: 'Hoy' };
                onFinish(result);
                setView('summary', result);
            };

            const format = s => {
                const m = Math.floor(s / 60);
                const sc = s % 60;
                return `${m}:${sc < 10 ? '0' : ''}${sc}`;
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col p-6 animate-scale-in">
                    <div className="absolute inset-0 opacity-50 bg-cover bg-center" style={{backgroundImage: `url("${workout.img || 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b'}")`}}></div>
                    <div className="absolute inset-0 bg-gradient-to-b from-black/60 via-black/40 to-black"></div>
                    <div className="relative z-10 flex-1 flex flex-col items-center justify-center">
                        <h2 className="text-white text-2xl font-bold mb-2 tracking-tight">{workout.title}</h2>
                        <h1 className="text-9xl font-black font-mono tracking-tighter text-white drop-shadow-2xl">{format(timeLeft)}</h1>
                        
                         <button onClick={addTime} className="mt-4 px-4 py-1 bg-white/10 rounded-full border border-white/20 text-xs font-bold active:scale-90 transition-transform text-white">+ 10 SEG</button>

                        <div className="flex gap-4 mt-8">
                            <div className="bg-white/10 backdrop-blur-md px-6 py-4 rounded-2xl flex flex-col items-center border border-white/10 min-w-[100px]"><span className="text-move font-bold text-2xl font-mono">{hr}</span><span className="text-[10px] font-bold text-move uppercase tracking-widest">BPM</span></div>
                            <div className="bg-white/10 backdrop-blur-md px-6 py-4 rounded-2xl flex flex-col items-center border border-white/10 min-w-[100px]"><span className="text-exercise font-bold text-2xl font-mono">{Math.floor(elapsed/60 * 7)}</span><span className="text-[10px] font-bold text-exercise uppercase tracking-widest">KCAL</span></div>
                        </div>
                    </div>
                    <div className="relative z-10 flex justify-center gap-10 pb-12 items-center">
                        <button onClick={() => setActive(!active)} className="w-20 h-20 rounded-full bg-white/20 backdrop-blur-lg flex items-center justify-center hover:bg-white/30 transition-colors"><span className="material-symbols-rounded text-5xl">{active ? 'pause' : 'play_arrow'}</span></button>
                        <button onClick={finish} className="w-24 h-24 rounded-full bg-ios-red flex items-center justify-center shadow-lg shadow-red-500/30 active:scale-95 transition-transform"><span className="material-symbols-rounded text-5xl text-black font-bold icon-filled">stop</span></button>
                    </div>
                </div>
            );
        };

        // 9. SUMMARY VIEW (UNCHANGED)
        const SummaryView = ({ setView, data }) => (
            <div className="flex flex-col min-h-screen bg-black p-6 animate-slide-in-up">
                <div className="flex justify-between items-center pt-4 mb-8"><h1 className="text-3xl font-bold text-white">Resumen</h1><button onClick={() => setView('dashboard')} className="w-8 h-8 rounded-full bg-ios-card flex items-center justify-center hover:bg-white/20"><span className="material-symbols-rounded text-gray-400">close</span></button></div>
                <div className="flex flex-col items-center mb-10 animate-scale-in"><div className="w-28 h-28 rounded-full border-[6px] border-exercise flex items-center justify-center mb-6 text-exercise shadow-[0_0_30px_rgba(164,255,0,0.2)]"><span className="material-symbols-rounded text-6xl icon-filled">check</span></div><h2 className="text-3xl font-bold text-white">¡Bien hecho!</h2></div>
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <Card className="p-4 border border-white/5"><p className="text-xs text-ios-gray font-bold mb-1 uppercase tracking-wider">Tiempo</p><p className="text-3xl font-mono text-exercise font-bold">{Math.floor(data.duration / 60)}:{(data.duration % 60).toString().padStart(2,'0')}</p></Card>
                    <Card className="p-4 border border-white/5"><p className="text-xs text-ios-gray font-bold mb-1 uppercase tracking-wider">Calorías</p><p className="text-3xl font-mono text-move font-bold">{data.kcal}</p></Card>
                </div>
                <Card className="p-4 mb-4 border border-white/5">
                    <p className="text-xs text-ios-gray font-bold mb-2 uppercase tracking-wider">Ritmo Cardíaco</p>
                    <div className="h-24 w-full relative opacity-80"><svg className="absolute inset-0 w-full h-full" preserveAspectRatio="none" viewBox="0 0 300 100"><path d="M0,60 Q25,20 50,65 T100,45 T150,70 T200,30 T250,60 T300,75" fill="none" stroke="#90E600" strokeWidth="3"></path><path d="M0,100 V60 Q25,20 50,65 T100,45 T150,70 T200,30 T250,60 T300,75 V100 Z" fill="url(#gradientGreen)" opacity="0.2"></path><defs><linearGradient id="gradientGreen" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stopColor="#90E600"/><stop offset="100%" stopColor="transparent"/></linearGradient></defs></svg></div>
                </Card>
                <div className="mt-auto"><Button onClick={() => setView('dashboard')}>Listo</Button></div>
            </div>
        );

        // 10. HISTORY LIST (UNCHANGED)
        const HistoryView = ({ setView, goBack, history }) => (
            <div className="flex flex-col min-h-screen bg-black animate-slide-in-right">
                <Header title="Historial" onBack={goBack} />
                <div className="p-4 pb-20 space-y-4">
                    {history.length === 0 ? <div className="text-center text-ios-gray mt-20 flex flex-col items-center gap-2"><span className="material-symbols-rounded text-5xl opacity-30">history</span><p>No hay historial reciente</p></div> : 
                    history.map((w, i) => (
                        <ListItem key={i} icon="fitness_center" label={w.title} value={w.date} onClick={() => setView('workoutDetail', w)} iconColor="bg-exercise text-black" />
                    ))}
                </div>
            </div>
        );

        // --- APP ROOT ---
        const App = () => {
            const [view, setCurrentView] = useState('auth');
            const [stack, setStack] = useState(['auth']);
            const [viewData, setViewData] = useState(null);
            
            // GLOBAL APP STATE
            const [user, setUser] = useState({ name: '', goal: '', level: '', email: '', avatar: '', password: '' });
            const [stats, setStats] = useState({ move: 0, exercise: 0, stand: 0 });
            const [target, setTarget] = useState({ move: 600, exercise: 30, stand: 12 });
            const [workoutHistory, setWorkoutHistory] = useState([]);
            const [plan, setPlan] = useState([]);

            const changeView = (nextView, data = null) => {
                setStack(p => [...p, nextView]);
                setViewData(data);
                setCurrentView(nextView);
                window.scrollTo(0,0);
            };

            const goBack = () => {
                if(stack.length > 1) {
                    const newStack = [...stack];
                    newStack.pop();
                    const prev = newStack[newStack.length - 1];
                    setStack(newStack);
                    setCurrentView(prev);
                }
            };

            const handleLogin = (userData, isNew) => {
                // Ensure password is saved to global user state
                setUser(prev => ({ ...prev, ...userData }));
                if (isNew) {
                    setStats({ move: 0, exercise: 0, stand: 0 });
                    setWorkoutHistory([]);
                    const rec = EXERCISE_DB.filter(e => (userData.goal.includes('músculo') && e.type === 'Fuerza') || (userData.level === e.level)).slice(0, 3);
                    setPlan(rec.length ? rec : EXERCISE_DB.slice(0, 3));
                } else {
                    setStats({ move: 450, exercise: 25, stand: 10 });
                    setWorkoutHistory([{ title: 'Carrera Matutina', time: 30, kcal: 320, date: 'Ayer' }]);
                    setPlan(EXERCISE_DB.slice(0,3));
                }
                changeView('dashboard');
            };

            const updateUser = (newData) => { setUser(prev => ({ ...prev, ...newData })); };
            const updateTarget = (newTarget) => { setTarget(prev => ({ ...prev, ...newTarget })); };

            const finishWorkout = (result) => {
                setStats(p => ({
                    move: p.move + result.kcal,
                    exercise: p.exercise + result.time,
                    stand: p.stand + (result.time > 20 ? 1 : 0) 
                }));
                setWorkoutHistory(p => [result, ...p]);
            };

            const render = () => {
                switch(view) {
                    case 'auth': return <AuthView setView={changeView} onLogin={handleLogin} />;
                    case 'dashboard': return <DashboardView setView={changeView} user={user} stats={stats} history={workoutHistory} plan={plan} target={target} />;
                    case 'fitness': return <FitnessPlusView setView={changeView} />;
                    case 'sharing': return <SharingView setView={changeView} />;
                    case 'settings': return <SettingsView setView={changeView} goBack={goBack} user={user} updateUser={updateUser} target={target} updateTarget={updateTarget} />;
                    case 'awards': return <AwardsView setView={changeView} goBack={goBack} history={workoutHistory} />;
                    case 'activityDetail': return <ActivityDetailView setView={changeView} goBack={goBack} data={{stats, target}} />;
                    case 'workoutDetail': return <WorkoutDetailView setView={changeView} goBack={goBack} data={viewData} />;
                    case 'activeWorkout': return <ActiveWorkoutView setView={changeView} goBack={goBack} data={viewData} onFinish={finishWorkout} />;
                    case 'summary': return <SummaryView setView={changeView} data={viewData} />;
                    case 'history': return <HistoryView setView={changeView} goBack={goBack} history={workoutHistory} />;
                    default: return <DashboardView setView={changeView} user={user} stats={stats} history={workoutHistory} plan={plan} target={target} />;
                }
            };

            return (
                <div className="mx-auto max-w-md bg-black min-h-screen relative overflow-hidden text-white selection:bg-primary selection:text-black">
                    {render()}
                    {['dashboard', 'fitness', 'sharing'].includes(view) && (
                        <div className="fixed bottom-0 w-full h-[83px] glass-nav z-50 flex justify-around items-center pb-4 max-w-md">
                            {[{id:'dashboard',i:'home',l:'Resumen'},{id:'fitness',i:'fitness_center',l:'Fitness+'},{id:'sharing',i:'group',l:'Compartir'}].map(b => (
                                <button key={b.id} onClick={()=>changeView(b.id)} className={`flex flex-col items-center w-16 ${view===b.id ? 'text-primary scale-105' : 'text-[#8E8E93]'} transition-all active:scale-95`}>
                                    <span className={`material-symbols-rounded text-[26px] ${view===b.id?'icon-filled':'icon-outlined'}`}>{b.i}</span>
                                    <span className="text-[10px] font-medium tracking-wide mt-0.5">{b.l}</span>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>